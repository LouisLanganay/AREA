FROM node:21.7.0

WORKDIR /server

COPY package*.json ./

RUN npm i

COPY . .

EXPOSE 8080

CMD echo "------------------------------------" && \
    echo "Before Prisma Migrate" && \
    sh -c 'until npx prisma migrate deploy; do echo "Retrying Prisma Migrate"; sleep 5; done' && \
    npx prisma generate && \
    echo "After Prisma Migrate" && \
    npm run dev